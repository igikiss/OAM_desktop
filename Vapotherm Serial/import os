import serial
import csv
import time
import glob

# Find the connected serial port
serial_port = glob.glob('/dev/ttyUSB*')[0]  # Assumes one USB serial port is connected
baud_rate = 9600  # Set the baud rate of your RS232 device

# Open the serial port
ser = serial.Serial(serial_port, baud_rate)

# Generate a unique file name based on timestamp
timestamp = time.strftime("%Y%m%d_%H%M%S")
output_file = f"rs232_data_{timestamp}.csv"

# Open the CSV file for writing
with open(output_file, 'w', newline='') as file:
    writer = csv.writer(file)
    writer.writerow(['Timestamp', 'Data'])

    try:
        # Read and save data from RS232
        while True:
            if ser.in_waiting > 0:
                data = ser.readline().decode('utf-8').strip()  # Read a line of data
                timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
                writer.writerow([timestamp, data])
                print(f"[{timestamp}] Data: {data}")

    except KeyboardInterrupt:
        pass

# Close the serial port
ser.close()
